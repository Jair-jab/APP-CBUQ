<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle CBUQ - Vers√£o Completa</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e9ecef; margin: 0; padding: 10px; }
        .container { max-width: 800px; background: white; padding: 20px; margin: 0 auto; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* Cabe√ßalho */
        header { text-align: center; border-bottom: 2px solid #0056b3; padding-bottom: 15px; margin-bottom: 20px; }
        h2 { margin: 0; color: #333; font-size: 20px; }
        h4 { margin: 5px 0 0; color: #666; font-weight: normal; }

        /* Login */
        #area-login { text-align: center; padding: 50px 20px; }
        #area-formulario { display: none; } 

        /* Formul√°rio */
        .section-title { background-color: #0056b3; color: white; padding: 10px; margin-top: 25px; border-radius: 6px; font-weight: bold; font-size: 14px; }
        label { display: block; margin-top: 10px; font-weight: 600; color: #444; font-size: 13px; }
        input, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        
        /* Bot√µes */
        .btn-action { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; color: white; }
        .btn-blue { background-color: #007bff; }
        .btn-green { background-color: #28a745; }
        .btn-orange { background-color: #fd7e14; }
        
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        #status-gps { font-size: 12px; color: #28a745; margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="area-login">
        <h2>üîí Acesso Restrito</h2>
        <p>Sistema de Controle CBUQ</p>
        <input type="password" id="senhaAcesso" placeholder="Digite a senha..." style="max-width: 200px; text-align: center;">
        <br>
        <button class="btn-action btn-blue" onclick="verificarAcesso()" style="max-width: 200px;">Entrar</button>
    </div>

    <div id="area-formulario">
        <header>
            <h2>Secretaria Municipal de Obras</h2>
            <h4>Controle de Execu√ß√£o - CBUQ</h4>
        </header>

        <form id="formObras">
            <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; text-align: center;">
                <button type="button" class="btn-action btn-blue" style="margin-top: 0; padding: 10px;" onclick="pegarGPS()">üìç Capturar Localiza√ß√£o GPS</button>
                <div id="status-gps">Aguardando...</div>
                <input type="hidden" id="gps-lat"><input type="hidden" id="gps-long">
            </div>

            <div class="section-title">1. Respons√°vel</div>
            <div class="row">
                <div class="col"><label>Respons√°vel:</label><input type="text" id="responsavel"></div>
                <div class="col"><label>Matr√≠cula:</label><input type="number" id="matricula"></div>
            </div>

            <div class="section-title">2. Identifica√ß√£o de Local e Servi√ßo</div>
            <label>Rua de Aplica√ß√£o:</label><input type="text" id="rua">
            <div class="row">
                <div class="col"><label>Bairro:</label><input type="text" id="bairro"></div>
                <div class="col"><label>Data:</label><input type="date" id="data"></div>
            </div>
            
            <div class="row">
                <div class="col"><label>Local Inicial:</label><input type="text" id="localInicial"></div>
                <div class="col"><label>Local Final:</label><input type="text" id="localFinal"></div>
            </div>

            <div class="row">
                <div class="col"><label>Temp. Amb. (¬∞C):</label><input type="number" id="tempAmbiente"></div>
                <div class="col">
                    <label>Tipo Material:</label>
                    <select id="tipoMaterial"><option value="CBUQ">CBUQ</option><option value="Outros">Outros</option></select>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>Tipo Servi√ßo:</label>
                    <select id="tipoServico">
                        <option value="Reperfilamento">Reperfilamento</option>
                        <option value="Capa">Capa Asf√°ltica</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div class="col">
                    <label>Tipo Base:</label>
                    <select id="tipoBase">
                        <option value="Alvenaria">Alvenaria</option>
                        <option value="BGS">BGS</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
            </div>

            <div class="section-title">3. Dados do Caminh√£o</div>
            <div class="row">
                <div class="col"><label>Placa:</label><input type="text" id="placa"></div>
                <div class="col"><label>N¬∫ Ticket:</label><input type="text" id="ticket"></div>
            </div>
            <div class="row">
                <div class="col"><label>Motorista:</label><input type="text" id="motorista"></div>
                <div class="col"><label>Carga (ton):</label><input type="number" step="0.01" id="carga"></div>
            </div>

            <div class="section-title">4. Controle de Temperaturas e Hor√°rios</div>
            <div class="row">
                <div class="col"><label>Sa√≠da Usina (Hora):</label><input type="time" id="horaSaida"></div>
                <div class="col"><label>Temp. Sa√≠da (¬∞C):</label><input type="number" id="tempSaida"></div>
            </div>
            <div class="row">
                <div class="col"><label>Recebimento (Hora):</label><input type="time" id="horaRecebimento"></div>
                <div class="col"><label>Temp. Receb. (¬∞C):</label><input type="number" id="tempRecebimento"></div>
            </div>
            <div class="row">
                <div class="col"><label>Esparrame (Hora):</label><input type="time" id="horaEsparrame"></div>
                <div class="col"><label>Temp. Espar. (¬∞C):</label><input type="number" id="tempEsparrame"></div>
            </div>
            <div class="row">
                <div class="col"><label>Compacta√ß√£o (Hora):</label><input type="time" id="horaCompactacao"></div>
                <div class="col"><label>Temp. Compac. (¬∞C):</label><input type="number" id="tempCompactacao"></div>
            </div>

            <label>Observa√ß√µes:</label>
            <input type="text" id="obs">

            <div class="section-title">üì∑ Registro Fotogr√°fico</div>
            <label>Anexar Foto da Obra (Opcional):</label>
            <input type="file" id="fotoObra" accept="image/*">

            <button type="button" class="btn-action btn-green" onclick="gerarPDF()">üìÑ Salvar PDF (Completo)</button>
            <button type="button" class="btn-action btn-orange" onclick="salvarCSV()">üìä Baixar Planilha (Excel)</button>
        </form>
    </div>
</div>

<script>
    // --- 1. LOGIN (Senha: 1234) ---
    function verificarAcesso() {
        if(document.getElementById('senhaAcesso').value === "1234") {
            document.getElementById('area-login').style.display = 'none';
            document.getElementById('area-formulario').style.display = 'block';
        } else { alert("Senha incorreta!"); }
    }

    // --- 2. GPS ---
    function pegarGPS() {
        if (navigator.geolocation) {
            document.getElementById('status-gps').innerText = "Buscando...";
            navigator.geolocation.getCurrentPosition(function(pos) {
                const lat = pos.coords.latitude;
                const long = pos.coords.longitude;
                document.getElementById('gps-lat').value = lat;
                document.getElementById('gps-long').value = long;
                document.getElementById('status-gps').innerText = `‚úÖ GPS: ${lat.toFixed(5)}, ${long.toFixed(5)}`;
            }, function() { alert("Erro ao pegar GPS. Ative a localiza√ß√£o."); });
        } else { alert("GPS n√£o suportado."); }
    }

    // --- 3. GERAR PDF COMPLETO ---
    function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Fun√ß√£o auxiliar para pegar valor ou tra√ßo
        const v = (id) => document.getElementById(id).value || "-";

        doc.setFont("helvetica", "bold"); doc.setFontSize(14);
        doc.text("RELAT√ìRIO DE CONTROLE DE CBUQ", 20, 20);
        
        doc.setFontSize(10); doc.setFont("helvetica", "normal");
        let y = 30; // Posi√ß√£o vertical inicial

        // Bloco 1
        doc.text(`Respons√°vel: ${v('responsavel')} | Matr√≠cula: ${v('matricula')}`, 20, y); y+=8;
        doc.text(`Data: ${v('data')} | Rua: ${v('rua')}`, 20, y); y+=8;
        doc.text(`Bairro: ${v('bairro')} | Temp. Amb: ${v('tempAmbiente')}¬∞C`, 20, y); y+=8;
        doc.text(`Local Inicial: ${v('localInicial')} | Local Final: ${v('localFinal')}`, 20, y); y+=8;
        
        // GPS
        const lat = document.getElementById('gps-lat').value;
        const long = document.getElementById('gps-long').value;
        if(lat) { doc.setTextColor(0,0,255); doc.text(`GPS: ${lat}, ${long}`, 20, y); doc.setTextColor(0,0,0); y+=8; }

        doc.line(20, y, 190, y); y+=10; // Linha

        // Bloco 2 - Materiais
        doc.setFont("helvetica", "bold"); doc.text("DADOS T√âCNICOS E DO CAMINH√ÉO", 20, y); y+=8;
        doc.setFont("helvetica", "normal");
        doc.text(`Material: ${v('tipoMaterial')} | Servi√ßo: ${v('tipoServico')} | Base: ${v('tipoBase')}`, 20, y); y+=8;
        doc.text(`Caminh√£o: ${v('placa')} | Motorista: ${v('motorista')}`, 20, y); y+=8;
        doc.text(`Ticket: ${v('ticket')} | Carga: ${v('carga')} ton`, 20, y); y+=8;

        doc.line(20, y, 190, y); y+=10;

        // Bloco 3 - Temperaturas
        doc.setFont("helvetica", "bold"); doc.text("CONTROLE DE TEMPERATURAS", 20, y); y+=8;
        doc.setFont("helvetica", "normal");
        doc.text(`Sa√≠da Usina: ${v('horaSaida')}h - ${v('tempSaida')}¬∞C`, 20, y); y+=8;
        doc.text(`Recebimento: ${v('horaRecebimento')}h - ${v('tempRecebimento')}¬∞C`, 20, y); y+=8;
        doc.text(`Esparrame: ${v('horaEsparrame')}h - ${v('tempEsparrame')}¬∞C`, 20, y); y+=8;
        doc.text(`Compacta√ß√£o: ${v('horaCompactacao')}h - ${v('tempCompactacao')}¬∞C`, 20, y); y+=8;
        
        y+=5;
        doc.text(`Obs: ${v('obs')}`, 20, y); y+=10;

        // Foto
        const inputFoto = document.getElementById('fotoObra');
        if (inputFoto.files && inputFoto.files[0]) {
            const reader = new FileReader();
            reader.readAsDataURL(inputFoto.files[0]);
            reader.onload = function(e) {
                doc.addImage(e.target.result, 'JPEG', 20, y, 100, 75); // Adiciona foto
                doc.save(`Relatorio_CBUQ_${v('data')}.pdf`);
            }
        } else {
            doc.save(`Relatorio_CBUQ_${v('data')}.pdf`);
        }
    }

    // --- 4. GERAR CSV COMPLETO ---
    function salvarCSV() {
        const campos = [
            "responsavel", "matricula", "rua", "bairro", "data", "localInicial", "localFinal", 
            "tempAmbiente", "tipoMaterial", "tipoServico", "tipoBase", "placa", "motorista", 
            "carga", "ticket", "horaSaida", "tempSaida", "horaRecebimento", "tempRecebimento", 
            "horaEsparrame", "tempEsparrame", "horaCompactacao", "tempCompactacao", "obs",
            "gps-lat", "gps-long"
        ];
        
        let csv = "\ufeffResponsavel;Matricula;Rua;Bairro;Data;Local Ini;Local Fim;Temp Amb;Material;Servico;Base;Placa;Motorista;Carga;Ticket;H.Saida;T.Saida;H.Receb;T.Receb;H.Espar;T.Espar;H.Comp;T.Comp;Obs;Lat;Long\n";
        
        let linha = [];
        campos.forEach(id => {
            let val = document.getElementById(id).value || "-";
            val = val.replace(/;/g, " "); // Evitar erros no CSV
            linha.push(val);
        });
        
        csv += linha.join(";") + "\n";
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Dados_CBUQ_${document.getElementById('data').value || 'hoje'}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>
